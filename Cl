import tkinter as tk
import sqlite3
from tkinter import messagebox
from tkinter import ttk

def conectar():
    return sqlite3.connect('teste.db')

def criar_tabela():
    conn = conectar()
    c = conn.cursor()
    c.execute('''CREATE TABLE IF NOT EXISTS usuarios (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        nome TEXT NOT NULL,
        email TEXT NOT NULL,
        telefone TEXT NOT NULL,  -- Changed to TEXT for flexibility (e.g., formatting)
        endereco TEXT NOT NULL   -- Fixed typo: endereço -> endereco (to avoid encoding issues)
    )''')
    conn.commit()
    conn.close()

criar_tabela()

# CRUD
# CREATE - criando os dados
def inserir_usuario():
    nome = entry_nome.get()
    email = entry_email.get()
    telefone = entry_telefone.get()
    endereco = entry_endereco.get()

    if nome and email and telefone and endereco:
        try:
            conn = conectar()
            c = conn.cursor()
            c.execute('INSERT INTO usuarios (nome, email, telefone, endereco) VALUES (?, ?, ?, ?)', 
                      (nome, email, telefone, endereco))
            conn.commit()
            conn.close()
            messagebox.showinfo('Sucesso', 'Dados inseridos com sucesso!')
            limpar_campos()
            mostrar_usuario()
        except Exception as e:
            messagebox.showerror('Erro', f'Erro ao inserir: {str(e)}')
    else:
        messagebox.showerror('Erro', 'Todos os campos são obrigatórios!')

# READ - lendo
def mostrar_usuario():
    for row in tree.get_children():
        tree.delete(row)
    try:
        conn = conectar()
        c = conn.cursor()
        c.execute('SELECT id, nome, email, telefone, endereco FROM usuarios')
        usuarios = c.fetchall()
        for usuario in usuarios:
            tree.insert("", 'end', values=usuario)
        conn.close()
    except Exception as e:
        messagebox.showerror('Erro', f'Erro ao carregar dados: {str(e)}')

# UPDATE - atualizando
def atualizar():
    selecao = tree.selection()
    if selecao:
        user_id = tree.item(selecao)['values'][0]
        novo_nome = entry_nome.get()
        novo_email = entry_email.get()
        novo_telefone = entry_telefone.get()
        novo_endereco = entry_endereco.get()

        if novo_nome and novo_email and novo_telefone and novo_endereco:
            try:
                conn = conectar()
                c = conn.cursor()
                c.execute('UPDATE usuarios SET nome = ?, email = ?, telefone = ?, endereco = ? WHERE id = ?',
                          (novo_nome, novo_email, novo_telefone, novo_endereco, user_id))
                conn.commit()
                conn.close()
                messagebox.showinfo('Sucesso', 'Dados atualizados com sucesso!')
                limpar_campos()
                mostrar_usuario()
            except Exception as e:
                messagebox.showerror('Erro', f'Erro ao atualizar: {str(e)}')
        else:
            messagebox.showerror('Erro', 'Todos os campos são obrigatórios!')
    else:
        messagebox.showwarning('Aviso', 'Selecione um usuário para atualizar!')

# DELETE - deletar o dado
def deletar():
    selecao = tree.selection()
    if selecao:
        user_id = tree.item(selecao)['values'][0]
        try:
            conn = conectar()
            c = conn.cursor()
            c.execute('DELETE FROM usuarios WHERE id = ?', (user_id,))
            conn.commit()
            conn.close()
            messagebox.showinfo('Sucesso', 'Dados deletados com sucesso!')
            limpar_campos()
            mostrar_usuario()
        except Exception as e:
            messagebox.showerror('Erro', f'Erro ao deletar: {str(e)}')
    else:
        messagebox.showerror('Erro', 'Selecione um usuário para deletar!')

# Função para limpar campos
def limpar_campos():
    entry_nome.delete(0, tk.END)
    entry_email.delete(0, tk.END)
    entry_telefone.delete(0, tk.END)
    entry_endereco.delete(0, tk.END)

# Função para preencher campos ao selecionar na treeview
def on_tree_select(event):
    selecao = tree.selection()
    if selecao:
        valores = tree.item(selecao)['values']
        entry_nome.delete(0, tk.END)
        entry_nome.insert(0, valores[1])  # Nome
        entry_email.delete(0, tk.END)
        entry_email.insert(0, valores[2])  # Email
        entry_telefone.delete(0, tk.END)
        entry_telefone.insert(0, valores[3])  # Telefone
        entry_endereco.delete(0, tk.END)
        entry_endereco.insert(0, valores[4])  # Endereco

# Interface gráfica
root = tk.Tk()
root.title('CRUD')
root.configure(bg="#599FCE")
# icone = 'img.ico'  # Uncomment if the file exists
# root.iconbitmap(icone)

fr1 = tk.Frame(root, bg="#3AD6DB")
fr1.grid(columnspan=4, pady=10)

label_nome = tk.Label(fr1, text='Nome: ', font=('Arial', 12), bg="#3AD6DB")
label_nome.grid(row=0, column=0, pady=5, padx=5, sticky='e')
entry_nome = tk.Entry(fr1, font=('Arial', 12))
entry_nome.grid(row=0, column=1, pady=5, padx=5)

label_email = tk.Label(fr1, text='E-mail: ', font=('Arial', 12), bg="#3AD6DB")
label_email.grid(row=1, column=0, pady=5, padx=5, sticky='e')
entry_email = tk.Entry(fr1, font=('Arial', 12))
entry_email.grid(row=1, column=1, pady=5, padx=5)

label_telefone = tk.Label(fr1, text='Telefone: ', font=('Arial', 12), bg="#3AD6DB")
label_telefone.grid(row=2, column=0, pady=5, padx=5, sticky='e')
entry_telefone = tk.Entry(fr1, font=('Arial', 12))
entry_telefone.grid(row=2, column=1, pady=5, padx=5)

label_endereco = tk.Label(fr1, text='Endereço: ', font=('Arial', 12), bg="#3AD6DB")
label_endereco.grid(row=3, column=0, pady=5, padx=5, sticky='e')
entry_endereco = tk.Entry(fr1, font=('Arial', 12))
entry_endereco.grid(row=3, column=1, pady=5, padx=5)

fr2 = tk.Frame(root, bg="#599FCE")
fr2.grid(columnspan=4, pady=10)

btn_salvar = tk.Button(fr2, text='Salvar', font=('Arial', 12), command=inserir_usuario)
btn_salvar.grid(row=0, column=0, pady=5, padx=5)

btn_atualizar = tk.Button(fr2, text='Atualizar', font=('Arial', 12), command=atualizar)
btn_atualizar.grid(row=0, column=1, pady=5, padx=5)

btn_deletar = tk.Button(fr2, text='Deletar', font=('Arial', 12), command=deletar)
btn_deletar.grid(row=0, column=2, pady=5, padx=5)

columns = ('ID', 'Nome', 'Email', 'Telefone', 'Endereço')
tree = ttk.Treeview(root, columns=columns, show='headings')
tree.grid(row=1, column=0, columnspan=4, padx=10, pady=10)  # Pequena mudança: movi para row=1 para evitar sobreposição

for col in columns:
    tree.heading(col, text=col)
    tree.column(col, width=120)

tree.bind('<<TreeviewSelect>>', on_tree_select)

mostrar_usuario()

root.mainloop()
